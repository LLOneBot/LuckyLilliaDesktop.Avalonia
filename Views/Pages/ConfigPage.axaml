<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:LuckyLilliaDesktop.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="800"
             x:Class="LuckyLilliaDesktop.Views.Pages.ConfigPage"
             x:DataType="vm:ConfigViewModel">

    <Grid RowDefinitions="Auto,*">
        <!-- 未保存提示横幅 -->
        <Border Grid.Row="0"
                Background="#F59E0B"
                Height="40"
                IsVisible="{Binding HasUnsavedChanges}">
            <StackPanel Orientation="Horizontal" 
                        HorizontalAlignment="Center" 
                        VerticalAlignment="Center"
                        Spacing="8">
                <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                          Width="18" Height="18"
                          Foreground="White"/>
                <TextBlock Text="配置已修改，请点击保存按钮保存更改"
                           Foreground="White"
                           FontWeight="Medium"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <ScrollViewer Grid.Row="1">
            <StackPanel Spacing="20" Margin="28">
                <!-- 标题 -->
                <DockPanel>
                    <PathIcon DockPanel.Dock="Left"
                              Data="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z"
                              Width="36" Height="36"
                              Foreground="{DynamicResource PrimaryBrush}"
                              Margin="0,0,12,0"/>
                    <TextBlock Text="系统配置"
                               FontSize="32"
                               FontWeight="Bold"
                               Foreground="{DynamicResource TextPrimary}"
                               VerticalAlignment="Center"/>
                </DockPanel>

                <Border Height="2" Background="{DynamicResource PrimaryBrush}" CornerRadius="1"/>

                <!-- 启动选项区域 -->
                <DockPanel>
                    <PathIcon DockPanel.Dock="Left"
                              Data="M8 5v14l11-7z"
                              Width="24" Height="24"
                              Foreground="{DynamicResource PrimaryBrush}"
                              Margin="0,0,10,0"/>
                    <TextBlock Text="启动选项"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimary}"
                               VerticalAlignment="Center"/>
                </DockPanel>
                <Border Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource BorderColor}"
                        BorderThickness="1"
                        CornerRadius="12"
                        Padding="24">
                    <StackPanel Spacing="16">
                        <!-- 自动登录 QQ 号 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="自动登录 QQ 号" Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Text="{Binding AutoLoginQQ}"
                                     Watermark="启动时自动登录的 QQ 号"
                                     Width="250"
                                     HorizontalAlignment="Left"/>
                        </StackPanel>

                        <!-- 启动选项复选框 -->
                        <CheckBox Content="启动软件后自动启动 Bot"
                                  IsChecked="{Binding AutoStartBot}"
                                  Foreground="{DynamicResource TextPrimary}"/>
                        <CheckBox Content="无头模式（不显示 QQ 窗口，可能有掉线风险）"
                                  IsChecked="{Binding Headless}"
                                  Foreground="{DynamicResource TextPrimary}"/>
                        <CheckBox Content="启动后自动缩进托盘"
                                  IsChecked="{Binding MinimizeToTrayOnStart}"
                                  Foreground="{DynamicResource TextPrimary}"/>
                        <CheckBox Content="开机自启"
                                  IsChecked="{Binding StartupEnabled}"
                                  Foreground="{DynamicResource TextPrimary}"/>

                        <Border Height="1" Background="{DynamicResource BorderColor}"/>

                        <!-- 启动命令 -->
                        <DockPanel>
                            <Button DockPanel.Dock="Right"
                                    Content="测试命令"
                                    Command="{Binding TestCommandCommand}"
                                    Margin="12,0,0,0"
                                    VerticalAlignment="Center"/>
                            <CheckBox Content="启用启动后自动运行命令"
                                      IsChecked="{Binding StartupCommandEnabled}"
                                      Foreground="{DynamicResource TextPrimary}"
                                      VerticalAlignment="Center"/>
                        </DockPanel>
                        <TextBox Text="{Binding StartupCommand}"
                                 Watermark="启动后将以多进程形式运行此命令"
                                 AcceptsReturn="True"
                                 Height="80"
                                 TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- 邮件通知区域 -->
                <DockPanel>
                    <PathIcon DockPanel.Dock="Left"
                              Data="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"
                              Width="24" Height="24"
                              Foreground="{DynamicResource PrimaryBrush}"
                              Margin="0,0,10,0"/>
                    <TextBlock Text="邮件通知"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimary}"
                               VerticalAlignment="Center"/>
                    <Button DockPanel.Dock="Right"
                            Content="设置向导"
                            Command="{Binding OpenEmailGuideCommand}"
                            Margin="12,0,0,0"
                            VerticalAlignment="Center"/>
                </DockPanel>
                <Border Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource BorderColor}"
                        BorderThickness="1"
                        CornerRadius="12"
                        Padding="24">
                    <StackPanel Spacing="16">
                        <CheckBox Content="启用掉线邮件通知"
                                  IsChecked="{Binding EmailEnabled}"
                                  Foreground="{DynamicResource TextPrimary}"/>

                        <Border Height="1" Background="{DynamicResource BorderColor}"/>

                        <!-- SMTP 服务器 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="SMTP 服务器" Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Text="{Binding SmtpHost}"
                                     Watermark="例如: smtp.qq.com"
                                     Width="300"
                                     HorizontalAlignment="Left"/>
                        </StackPanel>

                        <!-- SMTP 端口 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="SMTP 端口" Foreground="{DynamicResource TextSecondary}"/>
                            <NumericUpDown Value="{Binding SmtpPort}"
                                           Minimum="1"
                                           Maximum="65535"
                                           Width="150"
                                           HorizontalAlignment="Left"
                                           ShowButtonSpinner="False"/>
                        </StackPanel>

                        <!-- 加密方式 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="加密方式" Foreground="{DynamicResource TextSecondary}"/>
                            <ComboBox SelectedIndex="{Binding SmtpSecureModeIndex}"
                                      Width="300"
                                      HorizontalAlignment="Left">
                                <ComboBoxItem Content="STARTTLS（常用端口 587）"/>
                                <ComboBoxItem Content="SSL/TLS（常用端口 465）"/>
                            </ComboBox>
                            <TextBlock Foreground="{DynamicResource TextSecondary}" FontSize="12">
                                <Run Text="{Binding SmtpSecureModeDescription}"/>
                            </TextBlock>
                        </StackPanel>

                        <Border Height="1" Background="{DynamicResource BorderColor}"/>

                        <!-- SMTP 用户名 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="SMTP 用户名" Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Text="{Binding SmtpUser}"
                                     Watermark="邮箱账号"
                                     Width="300"
                                     HorizontalAlignment="Left"/>
                        </StackPanel>

                        <!-- SMTP 密码 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="SMTP 密码/授权码" Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Text="{Binding SmtpPass}"
                                     Watermark="邮箱密码或授权码"
                                     Width="300"
                                     HorizontalAlignment="Left"
                                     PasswordChar="●"/>
                        </StackPanel>

                        <Border Height="1" Background="{DynamicResource BorderColor}"/>

                        <!-- 发件人 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="发件人邮箱" Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Text="{Binding EmailFrom}"
                                     Watermark="发送通知的邮箱地址"
                                     Width="300"
                                     HorizontalAlignment="Left"/>
                        </StackPanel>

                        <!-- 收件人 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="收件人邮箱" Foreground="{DynamicResource TextSecondary}"/>
                            <TextBox Text="{Binding EmailTo}"
                                     Watermark="接收通知的邮箱地址"
                                     Width="300"
                                     HorizontalAlignment="Left"/>
                        </StackPanel>

                        <Border Height="1" Background="{DynamicResource BorderColor}"/>

                        <!-- 测试按钮 -->
                        <DockPanel>
                            <StackPanel DockPanel.Dock="Right"
                                        Orientation="Horizontal"
                                        Spacing="8"
                                        IsVisible="{Binding IsSendingTestEmail}">
                                <ProgressBar IsIndeterminate="True"
                                             Width="80"
                                             Height="4"
                                             VerticalAlignment="Center"/>
                                <TextBlock Text="发送中..."
                                           Foreground="{DynamicResource TextSecondary}"
                                           VerticalAlignment="Center"
                                           FontSize="12"/>
                            </StackPanel>
                            <Button Content="发送测试邮件"
                                    Command="{Binding TestEmailCommand}"
                                    IsEnabled="{Binding !IsSendingTestEmail}"
                                    HorizontalAlignment="Left"/>
                        </DockPanel>
                    </StackPanel>
                </Border>

                <!-- 日志设置区域 -->
                <DockPanel>
                    <PathIcon DockPanel.Dock="Left"
                              Data="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                              Width="24" Height="24"
                              Foreground="{DynamicResource PrimaryBrush}"
                              Margin="0,0,10,0"/>
                    <TextBlock Text="日志设置"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimary}"
                               VerticalAlignment="Center"/>
                </DockPanel>
                <Border Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource BorderColor}"
                        BorderThickness="1"
                        CornerRadius="12"
                        Padding="24">
                    <StackPanel Spacing="16">
                        <CheckBox Content="保存日志到文件"
                                  IsChecked="{Binding LogSaveEnabled}"
                                  Foreground="{DynamicResource TextPrimary}"/>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="日志保存时长（小时）"
                                       Foreground="{DynamicResource TextSecondary}"
                                       VerticalAlignment="Center"/>
                            <NumericUpDown Value="{Binding LogRetentionHours}"
                                           Minimum="0"
                                           Maximum="8760"
                                           Width="120"
                                           ShowButtonSpinner="False"/>
                            <TextBlock Text="（0 表示永久保存）"
                                       Foreground="{DynamicResource TextSecondary}"
                                       FontSize="12"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- 路径配置区域 -->
                <DockPanel>
                    <PathIcon DockPanel.Dock="Left"
                              Data="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"
                              Width="24" Height="24"
                              Foreground="{DynamicResource PrimaryBrush}"
                              Margin="0,0,10,0"/>
                    <TextBlock Text="路径配置"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimary}"
                               VerticalAlignment="Center"/>
                </DockPanel>
                <Border Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource BorderColor}"
                        BorderThickness="1"
                        CornerRadius="12"
                        Padding="24">
                    <StackPanel Spacing="16">
                        <!-- 工作目录（只读） -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="工作目录（数据存储位置）" Foreground="{DynamicResource TextSecondary}"/>
                            <DockPanel>
                                <Button DockPanel.Dock="Right"
                                        Content="打开"
                                        Command="{Binding OpenWorkingDirectoryCommand}"
                                        Margin="8,0,0,0"
                                        Width="80"/>
                                <TextBox Text="{Binding WorkingDirectory}"
                                         IsReadOnly="True"
                                         Watermark="当前工作目录"
                                         Background="{DynamicResource BackgroundSecondary}"/>
                            </DockPanel>
                        </StackPanel>

                        <Border Height="1" Background="{DynamicResource BorderColor}"/>

                        <!-- QQ 路径 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="QQ 路径" Foreground="{DynamicResource TextSecondary}"/>
                            <DockPanel>
                                <Button DockPanel.Dock="Right"
                                        Content="浏览..."
                                        Command="{Binding BrowseQQCommand}"
                                        Margin="8,0,0,0"
                                        Width="80"/>
                                <TextBox Text="{Binding QQPath}"
                                         Watermark="QQ 可执行文件的路径"/>
                            </DockPanel>
                        </StackPanel>

                        <!-- PMHQ 路径 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="PMHQ 路径" Foreground="{DynamicResource TextSecondary}"/>
                            <DockPanel>
                                <Button DockPanel.Dock="Right"
                                        Content="浏览..."
                                        Command="{Binding BrowsePmhqCommand}"
                                        Margin="8,0,0,0"
                                        Width="80"/>
                                <TextBox Text="{Binding PmhqPath}"
                                         Watermark="pmhq.exe 的路径"/>
                            </DockPanel>
                        </StackPanel>

                        <!-- LLBot 路径 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="LLBot 路径" Foreground="{DynamicResource TextSecondary}"/>
                            <DockPanel>
                                <Button DockPanel.Dock="Right"
                                        Content="浏览..."
                                        Command="{Binding BrowseLLBotCommand}"
                                        Margin="8,0,0,0"
                                        Width="80"/>
                                <TextBox Text="{Binding LLBotPath}"
                                         Watermark="llbot.js 的路径"/>
                            </DockPanel>
                        </StackPanel>

                        <!-- Node.js 路径 -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Node 路径" Foreground="{DynamicResource TextSecondary}"/>
                            <DockPanel>
                                <Button DockPanel.Dock="Right"
                                        Content="浏览..."
                                        Command="{Binding BrowseNodeCommand}"
                                        Margin="8,0,0,0"
                                        Width="80"/>
                                <TextBox Text="{Binding NodePath}"
                                         Watermark="node.exe 的路径"/>
                            </DockPanel>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- 底部留白 -->
                <Border Height="80"/>
            </StackPanel>
        </ScrollViewer>

        <!-- 悬浮按钮 -->
        <Border Grid.Row="1"
                CornerRadius="24"
                BoxShadow="0 4 16 0 #40000000"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="28,0,88,28">
            <Button Command="{Binding LoadConfigCommand}"
                    Classes="ActionButton"
                    Background="{DynamicResource CardBackgroundSecondary}"
                    Foreground="{DynamicResource TextPrimary}"
                    CornerRadius="24"
                    Width="48" Height="48"
                    BorderThickness="0"
                    ToolTip.Tip="重新加载">
                <PathIcon Data="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
                          Width="20" Height="20"/>
            </Button>
        </Border>
        
        <Border Grid.Row="1"
                CornerRadius="24"
                BoxShadow="0 4 16 0 #40000000"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="28,0,28,28">
            <Button Command="{Binding SaveConfigCommand}"
                    Classes="ActionButton"
                    Background="{DynamicResource PrimaryBrush}"
                    Foreground="White"
                    CornerRadius="24"
                    Width="48" Height="48"
                    BorderThickness="0"
                    IsEnabled="{Binding !IsSaving}"
                    ToolTip.Tip="保存配置">
                <PathIcon Data="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"
                          Width="20" Height="20"/>
            </Button>
        </Border>

        <!-- 加载指示器 -->
        <StackPanel Grid.Row="1"
                    Orientation="Horizontal" 
                    Spacing="12"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Bottom"
                    Margin="28,0,28,100"
                    IsVisible="{Binding IsSaving}">
            <ProgressBar IsIndeterminate="True"
                         Width="120"
                         Height="4"
                         VerticalAlignment="Center"/>
            <TextBlock Text="正在保存..."
                       Foreground="{DynamicResource TextSecondary}"
                       VerticalAlignment="Center"
                       FontSize="14"/>
        </StackPanel>
    </Grid>
</UserControl>
