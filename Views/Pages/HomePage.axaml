<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:LuckyLilliaDesktop.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="700"
             x:Class="LuckyLilliaDesktop.Views.Pages.HomePage"
             x:DataType="vm:HomeViewModel">

    <Panel>
        <!-- 主内容区域 -->
        <ScrollViewer>
            <StackPanel Spacing="16" Margin="24">
                <!-- 更新提示横幅 -->
                <Border Background="#F59E0B"
                        CornerRadius="8"
                        Padding="16,8"
                        IsVisible="{Binding HasUpdate}">
                    <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <PathIcon Data="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12z"
                                  Width="20" Height="20"
                                  Foreground="White"
                                  VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding UpdateBannerText}" 
                                   Foreground="White" 
                                   FontSize="14"
                                   TextWrapping="Wrap"
                                   MaxWidth="500"
                                   VerticalAlignment="Center"/>
                        <Button Content="更新"
                                Command="{Binding UpdateCommand}"
                                Background="Transparent"
                                Foreground="White"
                                Padding="8,4"
                                VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- 错误提示横幅 -->
                <Border Background="{DynamicResource DangerColor}"
                        CornerRadius="8"
                        Padding="16,12"
                        IsVisible="{Binding HasError}">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                                  Width="24" Height="24"
                                  Foreground="White"/>
                        <TextBlock Text="{Binding ErrorMessage}"
                                   Foreground="White"
                                   FontSize="14"
                                   TextWrapping="Wrap"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- 标题 -->
                <DockPanel>
                    <PathIcon DockPanel.Dock="Left"
                              Data="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
                              Width="36" Height="36"
                              Foreground="{DynamicResource PrimaryBrush}"
                              Margin="0,0,12,0"/>
                    <TextBlock Text="{Binding Title}"
                               FontSize="32"
                               FontWeight="Bold"
                               Foreground="{DynamicResource TextPrimary}"
                               VerticalAlignment="Center"/>
                </DockPanel>
                <Border Height="2" Background="{DynamicResource PrimaryBrush}" CornerRadius="1"/>

                <!-- 进程资源监控标题 -->
                <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,8,0,0">
                    <PathIcon Data="M15 9H9v6h6V9zm-2 4h-2v-2h2v2zm8-2V9h-2V7c0-1.1-.9-2-2-2h-2V3h-2v2h-2V3H9v2H7c-1.1 0-2 .9-2 2v2H3v2h2v2H3v2h2v2c0 1.1.9 2 2 2h2v2h2v-2h2v2h2v-2h2c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2zm-4 6H7V7h10v10z"
                              Width="24" Height="24"
                              Foreground="{DynamicResource PrimaryBrush}"/>
                    <TextBlock Text="进程资源监控"
                               FontSize="22"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimary}"/>
                </StackPanel>

                <!-- 进程卡片：Bot占用 和 QQ -->
                <UniformGrid Columns="2">
                    <!-- Bot占用 卡片（整合 Manager、PMHQ、LLBot） -->
                    <Border Background="{DynamicResource CardBackground}"
                            BorderBrush="{DynamicResource BorderColor}"
                            BorderThickness="1"
                            CornerRadius="12" Padding="16" Margin="0,0,8,0">
                        <StackPanel Spacing="12">
                            <!-- 标题行 -->
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <PathIcon Data="M17.5 15.5c0 1.61-1.39 3-3 3-.49 0-.97-.13-1.39-.35L7.5 21l.75-3.75C7.49 16.57 7 15.59 7 14.5c0-2.21 1.79-4 4-4 2.21 0 4 1.79 4 4 0 .5-.09.97-.26 1.4l2.82-2.82c.28.48.44 1.03.44 1.62zM12 6c2.76 0 5 2.24 5 5 0 .51-.08 1-.22 1.46l1.71-1.71c.01-.25.01-.5.01-.75 0-3.86-3.14-7-7-7-1.93 0-3.68.79-4.94 2.06l1.42 1.42C8.95 5.55 10.4 5 12 5zm0 1c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.37l5.59-5.59C13.71 7.29 12.89 7 12 7z"
                                          Width="20" Height="20"
                                          Foreground="{DynamicResource PrimaryBrush}"/>
                                <TextBlock Text="Bot占用"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimary}"/>
                            </StackPanel>
                            <!-- 状态行 -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <Ellipse Width="16" Height="16"
                                         Fill="{Binding BotStatus, Converter={StaticResource StatusToColorConverter}}"/>
                                <TextBlock Text="{Binding BotStatusText}"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextSecondary}"/>
                            </StackPanel>
                            <Border Height="1" Background="{DynamicResource BorderColor}"/>
                            <!-- CPU -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="{Binding BotCpu, StringFormat=CPU: {0:F1}%}"
                                           FontSize="14"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextPrimary}"/>
                                <ProgressBar Value="{Binding BotCpu}" Maximum="100" Height="6"
                                             Foreground="{DynamicResource PrimaryBrush}" Background="{DynamicResource BorderColor}"/>
                            </StackPanel>
                            <!-- 内存 -->
                            <StackPanel Spacing="6">
                                <TextBlock FontSize="14"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextPrimary}">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0:F0} MB 已用 / {1:F0} MB 可用">
                                            <Binding Path="BotMemory"/>
                                            <Binding Path="AvailableMemory"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                                <ProgressBar Value="{Binding BotMemory}" Maximum="{Binding TotalMemory}" Height="6"
                                             Foreground="{DynamicResource SuccessColor}" Background="{DynamicResource BorderColor}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- QQ 卡片 -->
                    <Border Background="{DynamicResource CardBackground}"
                            BorderBrush="{DynamicResource BorderColor}"
                            BorderThickness="1"
                            CornerRadius="12" Padding="16" Margin="8,0,0,0">
                        <StackPanel Spacing="12">
                            <!-- 标题行 -->
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <PathIcon Data="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"
                                          Width="20" Height="20"
                                          Foreground="{DynamicResource PrimaryBrush}"/>
                                <TextBlock Text="QQ"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimary}"/>
                                <TextBlock Text="{Binding QQVersion}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextSecondary}"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding QQVersion, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            </StackPanel>
                            <!-- 状态行 -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <Ellipse Width="16" Height="16"
                                         Fill="{Binding QQStatus, Converter={StaticResource StatusToColorConverter}}"/>
                                <TextBlock Text="{Binding QQStatusText}"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextSecondary}"/>
                            </StackPanel>
                            <Border Height="1" Background="{DynamicResource BorderColor}"/>
                            <!-- CPU -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="{Binding QQCpu, StringFormat=CPU: {0:F1}%}"
                                           FontSize="14"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextPrimary}"/>
                                <ProgressBar Value="{Binding QQCpu}" Maximum="100" Height="6"
                                             Foreground="{DynamicResource PrimaryBrush}" Background="{DynamicResource BorderColor}"/>
                            </StackPanel>
                            <!-- 内存 -->
                            <StackPanel Spacing="6">
                                <TextBlock FontSize="14"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextPrimary}">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0:F0} MB 已用 / {1:F0} MB 可用">
                                            <Binding Path="QQMemory"/>
                                            <Binding Path="AvailableMemory"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                                <ProgressBar Value="{Binding QQMemory}" Maximum="{Binding TotalMemory}" Height="6"
                                             Foreground="{DynamicResource SuccessColor}" Background="{DynamicResource BorderColor}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </UniformGrid>

                <!-- 最近日志卡片 -->
                <Border Background="{DynamicResource CardBackground}"
                        BorderBrush="{DynamicResource BorderColor}"
                        BorderThickness="1"
                        CornerRadius="12" Padding="24" Height="300">
                    <DockPanel>
                        <!-- 标题行 -->
                        <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <PathIcon Data="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5M16 13H8M16 17H8M10 9H8"
                                          Width="24" Height="24"
                                          Foreground="{DynamicResource PrimaryBrush}"/>
                                <TextBlock Text="最近日志"
                                           FontSize="20"
                                           FontWeight="Bold"
                                           Foreground="{DynamicResource TextPrimary}"/>
                            </StackPanel>
                            <Button DockPanel.Dock="Right"
                                    Content="查看全部 →"
                                    Command="{Binding ViewAllLogsCommand}"
                                    Background="Transparent"
                                    Foreground="{DynamicResource PrimaryBrush}"
                                    HorizontalAlignment="Right"/>
                        </DockPanel>
                        <Border Height="1" Background="{DynamicResource BorderColor}" DockPanel.Dock="Top" Margin="0,0,0,16"/>

                        <!-- 日志内容 -->
                        <Border Background="{DynamicResource MainBackground}"
                                BorderBrush="{DynamicResource BorderColor}"
                                BorderThickness="1"
                                CornerRadius="8" Padding="12">
                            <Panel>
                                <!-- 空状态 -->
                                <TextBlock Text="暂无日志"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondary}"
                                           FontStyle="Italic"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding !HasRecentLogs}"/>
                                <!-- 日志列表 -->
                                <ScrollViewer x:Name="RecentLogsScrollViewer"
                                              IsVisible="{Binding HasRecentLogs}">
                                    <ItemsControl ItemsSource="{Binding RecentLogs}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="vm:LogEntryViewModel">
                                                <TextBlock Text="{Binding FormattedText}"
                                                           FontFamily="Cascadia Code,Consolas,Courier New,Segoe UI Emoji,Microsoft YaHei"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource TextPrimary}"
                                                           TextTrimming="CharacterEllipsis"
                                                           Margin="0,2"
                                                           Classes.error="{Binding IsError}"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                        <ItemsControl.Styles>
                                            <Style Selector="TextBlock.error">
                                                <Setter Property="Foreground" Value="{DynamicResource DangerColor}"/>
                                            </Style>
                                        </ItemsControl.Styles>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Panel>
                        </Border>
                    </DockPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- 下载进度遮罩层 -->
        <Border Background="#D0000000"
                IsVisible="{Binding IsDownloading}"
                CornerRadius="12">
            <Border Background="{DynamicResource CardBackground}"
                    BorderBrush="{DynamicResource BorderColor}"
                    BorderThickness="1"
                    CornerRadius="16"
                    Padding="32"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MinWidth="400">
                <StackPanel Spacing="20">
                    <!-- 标题 -->
                    <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                        <PathIcon Data="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"
                                  Width="28" Height="28"
                                  Foreground="{DynamicResource PrimaryBrush}"/>
                        <TextBlock Text="正在下载"
                                   FontSize="22"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimary}"/>
                    </StackPanel>

                    <!-- 下载项目 -->
                    <TextBlock Text="{Binding DownloadingItem}"
                               FontSize="16"
                               FontWeight="Medium"
                               Foreground="{DynamicResource TextSecondary}"
                               HorizontalAlignment="Center"/>

                    <!-- 进度条 -->
                    <StackPanel Spacing="8">
                        <ProgressBar Value="{Binding DownloadProgress}"
                                     Maximum="100"
                                     Height="8"
                                     Foreground="{DynamicResource PrimaryBrush}"
                                     Background="{DynamicResource BorderColor}"
                                     CornerRadius="4"/>
                        <DockPanel>
                            <TextBlock Text="{Binding DownloadStatus}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondary}"/>
                            <TextBlock Text="{Binding DownloadProgress, StringFormat={}{0:F0}%}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondary}"
                                       HorizontalAlignment="Right"/>
                        </DockPanel>
                    </StackPanel>

                    <!-- 取消按钮 -->
                    <Button Command="{Binding CancelDownloadCommand}"
                            HorizontalAlignment="Center"
                            Background="{DynamicResource DangerColor}"
                            Foreground="White"
                            Padding="24,10"
                            CornerRadius="6">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                      Width="16" Height="16"
                                      Foreground="White"/>
                            <TextBlock Text="取消下载" FontSize="14" Foreground="White"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </Border>

        <!-- 浮动启动/停止按钮 -->
        <Button Classes="ActionButton"
                Command="{Binding GlobalStartStopCommand}"
                IsEnabled="{Binding IsButtonEnabled}"
                HorizontalAlignment="Center"
                VerticalAlignment="Bottom"
                Margin="0,0,0,16"
                Width="120"
                Height="48"
                CornerRadius="24"
                Background="{Binding StartButtonBackground}"
                IsVisible="{Binding !IsDownloading}">
            <TextBlock Text="{Binding StartButtonText}"
                       FontSize="16"
                       FontWeight="Medium"
                       Foreground="White"/>
        </Button>
    </Panel>
</UserControl>
